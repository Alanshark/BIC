<style>
    #messages {
        height: 400px;
        overflow-y: auto;
    }
    .message {
        padding: 5px 10px;
        border-radius: 10px;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .other-user {
        background-color: #90EE90;
        border: 1px solid #ddd;
        margin-bottom: 5px;
    }
    .current-user {
        background-color: #FFFFFF;
        text-align: right;
        border: 1px solid #ddd;
        margin-bottom: 5px;
    }
    .chat-input {
        display: flex;
        align-items: center;
    }
    .chat-input input {
        flex-grow: 1;
        margin-right: 10px;
    }
</style>
<html>
    <div class="container mt-4">
        <h3>Chat Room: {{ room }}</h3>
        <div class="card">
            <div class="card-body" id="messageContainer">
                <ul id="messages" class="list-group"></ul>
            </div>
            <div class="card-footer chat-input">
                <input type="text" id="message" class="form-control" placeholder="Enter a message..." onkeydown="handleEnter(event)">
                <button onclick="sendMessage()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>    

    <!-- 用户名输入模态框 -->
    <div class="modal" tabindex="-1" role="dialog" id="usernameModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enter your username</h5>
                </div>
                <div class="modal-body">
                    <input type="text" id="username" class="form-control" placeholder="Username">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="joinChat()">Join Chat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var userName;
        var avtar_color;
        var room = "{{ room }}";
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        $(document).ready(function() {
            $('#usernameModal').modal({
                backdrop: 'static',
                keyboard: false
            });
        });

        function joinChat() {
            userName = document.getElementById('username').value;
            avtar_color = getRandomColor();
            if (userName) {
                $('#usernameModal').modal('hide');
                socket.emit('text_join', {username: userName, room: room});
            } else {
                alert('Please enter a username.');
            }
        }

        socket.on('connect', function() {
            // 用户名将在 joinChat 函数中通过模态框获得
        });

        socket.on('message', function(data) {
    var messages = document.getElementById('messages');
    var isCurrentUser = data.user === userName;
    var msgClass = isCurrentUser ? 'current-user' : 'other-user';
    var avatarHtml = '<span style="height: 30px; width: 30px; background-color: ' + data.avtar_color + '; border-radius: 50%; display: inline-block;"></span><br><small>' + data.user + '</small><br>';
    var msgHtml = '<li class="list-group-item ' + msgClass + '">' + avatarHtml + ' ' + data.msg + '</li>';

    // Add the new message to the bottom of the list
    messages.innerHTML += msgHtml;

    scrollToBottom(); // Scroll to the bottom after adding the new message
});

function sendMessage(){
    var message = document.getElementById('message').value;
    socket.emit('message', {msg: message, user: userName, room: room,avtar_color:avtar_color});
    document.getElementById('message').value = '';
}

function scrollToBottom() {
    var messageContainer = document.getElementById('messages');
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent default behavior of Enter key
        sendMessage(); // Call the sendMessage function when Enter is pressed
    }
}

        
        window.onbeforeunload = function() {
            socket.emit('leave', {username: userName, room: room});
        };
    </script>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

</html>