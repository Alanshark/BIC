<!-- CSS 樣式表 -->
<style>
    /* 訊息容器的樣式 */
    #messages {
        height: 400px;
        overflow-y: auto;
    }
    /* 訊息框的樣式 */
    .message {
        padding: 5px 10px;
        border-radius: 10px;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    /* 其他使用者的訊息框樣式 */
    .other-user {
        background-color: #90EE90;
        border: 1px solid #ddd;
        margin-bottom: 5px;
    }
    /* 當前使用者的訊息框樣式 */
    .current-user {
        background-color: #FFFFFF;
        text-align: right;
        border: 1px solid #ddd;
        margin-bottom: 5px;
    }
    /* 聊天輸入框的樣式 */
    .chat-input {
        display: flex;
        align-items: center;
    }
    .chat-input input {
        flex-grow: 1;
        margin-right: 10px;
    }
</style>

<!-- HTML 主體內容 -->
<html>
    <div class="container mt-4">
        <!-- 聊天室標題及訊息顯示區 -->
        <h3>Chat Room: {{ room }}</h3>
        <div class="card">
            <div class="card-body" id="messageContainer">
                <ul id="messages" class="list-group"></ul>
            </div>
            <div class="card-footer chat-input">
                <input type="text" id="message" class="form-control" placeholder="Enter a message..." onkeydown="handleEnter(event)">
                <button onclick="sendMessage()" class="btn btn-primary">Send</button>
            </div>
        </div>

        <!-- 使用者列表及開始遊戲按鈕 -->
        <div id="userListContainer" style="display: none;">
            <h3>使用者列表</h3>
            <select id="userSelect">
                <!-- 用 JavaScript 動態添加用戶選項 -->
            </select>
            <button onclick="startGame()">開始遊戲</button>
        </div>
    </div>    

    <!-- 井字遊戲版面 -->
    <div class="container mt-4">
        <div id="gameBoard" class="game-board" style="display: none;">
            <!-- 井字遊戲棋盤 -->
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <table class="table table-bordered text-center">
                        <!-- 九宮格 -->
                        <tr>
                            <td class="cell" id="cell0" onclick="cellClicked(0)"></td>
                            <td class="cell" id="cell1" onclick="cellClicked(1)"></td>
                            <td class="cell" id="cell2" onclick="cellClicked(2)"></td>
                        </tr>
                        <tr>
                            <td class="cell" id="cell3" onclick="cellClicked(3)"></td>
                            <td class="cell" id="cell4" onclick="cellClicked(4)"></td>
                            <td class="cell" id="cell5" onclick="cellClicked(5)"></td>
                        </tr>
                        <tr>
                            <td class="cell" id="cell6" onclick="cellClicked(6)"></td>
                            <td class="cell" id="cell7" onclick="cellClicked(7)"></td>
                            <td class="cell" id="cell8" onclick="cellClicked(8)"></td>
                        </tr>
                    </table>
                </div>
            </div>
            <!-- 重來跟退出按鈕區域 -->
            <div class="row justify-content-center mt-3">
                <button onclick="restartGame()" class="btn btn-secondary mr-2">重來</button>
                <button onclick="exitGame()" class="btn btn-danger">退出遊戲</button>
            </div>
        </div>

    </div>

    <!-- 使用者名稱輸入模態框 -->
    <div class="modal" tabindex="-1" role="dialog" id="usernameModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">請輸入您的使用者名稱</h5>
                </div>
                <div class="modal-body">
                    <input type="text" id="username" class="form-control" placeholder="Username">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="joinChat()">加入聊天</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var userName;
        var avtar_color;
        var room = "{{ room }}";
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        $(document).ready(function() {
            $('#usernameModal').modal({
                backdrop: 'static',
                keyboard: false
            });
        });

        function joinChat() {
            userName = document.getElementById('username').value;
            avtar_color = getRandomColor();
            if (userName) {
                // 设置用户名的 Cookie
                document.cookie = "username=" + userName + "; path=/";  // 这里的 path=/ 表示 Cookie 可以在整个站点中使用
        
                $('#usernameModal').modal('hide');
                socket.emit('text_join', {username: userName, room: room});
            } else {
                alert('Please enter a username.');
            } 
        }
        

        socket.on('connect', function() {
            // 用户名将在 joinChat 函数中通过模态框获得
        });
        document.getElementById("username").addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                joinChat();
            }
        });
        socket.on('message', function(data) {
            var messages = document.getElementById('messages');
            var isCurrentUser = data.user === userName;
            var msgClass = isCurrentUser ? 'current-user' : 'other-user';
            var avatarHtml = '<span style="height: 30px; width: 30px; background-color: ' + data.avtar_color + '; border-radius: 50%; display: inline-block;"></span><br><small>' + data.user + '</small><br>';
            var msgHtml = '<li class="list-group-item ' + msgClass + '">' + avatarHtml + ' ' + data.msg + '</li>';

            // Add the new message to the bottom of the list
            messages.innerHTML += msgHtml;

            scrollToBottom(); // Scroll to the bottom after adding the new message
        });

        function sendMessage(){
            var message = document.getElementById('message').value;
            socket.emit('message', {msg: message, user: userName, room: room,avtar_color:avtar_color});
            document.getElementById('message').value = '';
        }

        function scrollToBottom() {
            var messageContainer = document.getElementById('messages');
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default behavior of Enter key
                sendMessage(); // Call the sendMessage function when Enter is pressed
            }
        }

        socket.on('update_users_list', function(data) {
            var userListContainer = document.getElementById('userListContainer');
            userListContainer.style.display = 'block'; // 顯示使用者列表
        
            var userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = ''; // 清空選項列表
        
            data.users.forEach(function(user) {
                var option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
        });

        var currentPlayer = ''; // 當前玩家
        var gameBoard = ['', '', '', '', '', '', '', '', '']; // 遊戲棋盤
        var gameActive = true; // 遊戲是否進行中

        // 更新遊戲狀態到伺服器
        function updateGameState(cell) {
            if (!gameActive) return;
            socket.emit('game_move', { cell: cell, currentPlayer: currentPlayer, room: room });
        }

        // 接收遊戲棋盤更新
        socket.on('update_game_board', function(data) {
            gameBoard = data.gameBoard;
            refreshGameBoard();
            gameActive = data.gameActive;
            checkGameStatus();
        });

        // 接收遊戲狀態更新
        socket.on('game_update', function(data) {
            gameBoard = data.gameBoard;
            refreshGameBoard();
            gameActive = data.gameActive;
            checkGameStatus();
        });

        // 玩家選擇棋盤位置
        function cellClicked(cell) {
            if (!gameActive) return;

            if (gameBoard[cell] === '') {
                gameBoard[cell] = currentPlayer;
                document.getElementById('cell' + cell).innerText = gameBoard[cell];

                // 更新遊戲狀態
                updateGameState(cell);

                // 檢查是否有玩家贏得遊戲
                checkGameStatus();

                // 交換玩家
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            }
        }

        // 更新遊戲狀態（勝利或平局）
        function checkGameStatus() {
            const winningConditions = [
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                [0, 3, 6],
                [1, 4, 7],
                [2, 5, 8],
                [0, 4, 8],
                [2, 4, 6]
            ];

            for (let i = 0; i < winningConditions.length; i++) {
                const [a, b, c] = winningConditions[i];
                if (gameBoard[a] !== '' && gameBoard[a] === gameBoard[b] && gameBoard[a] === gameBoard[c]) {
                    gameActive = false;
                    alert('玩家 ' + gameBoard[a] + ' 獲勝！');
                    break;
                }
            }

            if (!gameBoard.includes('') && gameActive) {
                gameActive = false;
                alert('遊戲結束，平局！');
            }
        }

        // 刷新遊戲棋盤畫面
        function refreshGameBoard() {
            for (let i = 0; i < gameBoard.length; i++) {
                document.getElementById('cell' + i).innerText = gameBoard[i];
            }
        }

        // 當遊戲開始時
        function startGame() {
            var userSelect = document.getElementById('userSelect');
            var selectedOption = userSelect.options[userSelect.selectedIndex];
            var selectedUser = selectedOption.value;
        
            if (selectedUser) {
                // 發送邀請給選定玩家
                socket.emit('game_invite', { sender: userName, receiver: selectedUser, room: room });
            } else {
                alert('Please select a user!');
            }
        }
        
        // 接收遊戲邀請
        socket.on('game_invite', function(data) {
            var confirmed = confirm('您收到 ' + data.sender + ' 的遊戲邀請。是否接受？');
            if (confirmed) {
                // 如果接受邀請，開始遊戲
                socket.emit('game_accepted', { sender: data.sender, receiver: data.receiver, room: data.room });

                // 開始遊戲的畫面處理（這部分可能需要更多的邏輯，例如隱藏介面、顯示遊戲區域等）
                document.getElementById('gameBoard').style.display = 'block';
            }
        });
        
        // 開始遊戲
        socket.on('game_started', function(data) {
            // 檢查遊戲狀態是否為開始狀態
            if (!gameActive) {
                gameActive = true;
                // 開始遊戲，顯示遊戲棋盤
                document.getElementById('gameBoard').style.display = 'block';
            }
        });
        
        // 接受遊戲邀請
        socket.on('game_accepted', function(data) {
            if (userName === data.receiver) {
                // 如果是接收邀請的用戶，開始遊戲
                socket.emit('game_started', { room: data.room });
            }
        });

        // 顯示使用者列表並將選項加入到選擇列表
        socket.on('update_users_list', function(data) {
            var userListContainer = document.getElementById('userListContainer');
            userListContainer.style.display = 'block';

            var userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '';

            data.users.forEach(function(user) {
                var option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
        });

        // 重啟遊戲函式
        function restartGame() {
            // 清空遊戲區域，重置遊戲狀態等
            gameBoard = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = ''; // 重置當前玩家
            gameActive = true; // 重置遊戲狀態為進行中

            // 刷新遊戲畫面
            refreshGameBoard();
        }

        // 退出遊戲函式
        function exitGame() {
            // 隱藏遊戲區域
            document.getElementById('gameBoard').style.display = 'none';
            // 清空遊戲區域，重置遊戲狀態等
            gameBoard = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = ''; // 重置當前玩家
            gameActive = false; // 重置遊戲狀態為沒有進行

            // 刷新遊戲畫面
            refreshGameBoard();
            // 可以額外加上其他退出遊戲時需要處理的邏輯
        }
        
        
        window.onbeforeunload = function() {
            socket.emit('leave', {username: userName, room: room});
        };
    </script>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

</html>